#!/usr/bin/env node

/*
 * Expediente CLI
 */

var program = require('commander');
var pkg = require('../package.json');
var lib = require('../lib');
var defaults = require('../conf');
var expediente = require('../');
var logger = console.log;
var config = {};
var userConfig;

// Arguments
program
  .version(pkg.version)
  .usage('<HH:mm> [options]')
  .option('-h, --hours <HH:mm>', 'hours [HH:mm]')
  .option('-t, --tolerance <HH:mm>', 'tolerance [HH:mm]')
  .option('-c, --config <file>', 'choose config file')
  .option('-s, --simple', 'output finish time only');

// Help
program.on('--help', function () {
  logger('  Config:');
  logger('');
  logger('    If the file ~/.expedienteconfig.json exists, expediente will ');
  logger('    use it\'s contents as settings for default expedient duration');
  logger('    or tolerance time. Any parameter will override the file config');
  logger('');
  logger('    See https://github.com/guilhermehn/expediente/blob/master/README.md');
  logger('    for example config.');
  logger('');
});

program.parse(process.argv);

// Set config load
userConfig = lib.loadConfig(program.config || '~/.expedienteconfig.json');

if (userConfig) {
  Object
    .keys(defaults)
    .forEach(function (key) {
      config[key] = (userConfig.hasOwnProperty(key) ? userConfig : defaults)[key];
    });
}
else {
  config = defaults;
}

// Show help text if the default
// argument is not present
if (!program.args.length) {
  program.help();
}

config.start = program.args[0];

if (program.hours) {
  config.hours = program.hours;
}

if (program.tolerance) {
  config.tolerance = program.tolerance;
}

if (program.simple) {
  config.simple = program.simple;
}
else {
  logger = lib.logDetailed;
}

var result = expediente(config);

if (result === null) {
  console.log('\n  Invalid argument');
  program.help();
}

logger(result);
