#!/usr/bin/env node

/*
 * Expediente CLI
 */

var program = require('commander')
  , util = require('util')
  , pkg = require('../package.json')
  , lib = require('../lib')
  , defaults = require('../conf')
  , expediente = require('../')
  , defaultConfig = require('pwuid')().dir + '/.expedienteconfig.json'
  , log = console.log
  , config = {}
  , configDir
  , configFile

// Arguments
program
  .version(pkg.version)
  .usage('<HH:mm> [options]')
  .option('-h, --hours <HH:mm>', 'hours [HH:mm]')
  .option('-t, --tolerance <HH:mm>', 'tolerance [HH:mm]')
  .option('-c, --config <file>', 'choose config file')
  .option('-D, --detailed', 'detailed result')

// Help
program.on('--help', function(){
  log('  Config:')
  log('')
  log('    If the file ~/.expedienteconfig.json exists, expediente will ')
  log('    use it\'s contents as settings for default expedient duration')
  log('    or tolerance time. Any parameter will override the file config')
  log('')
  log('    See https://github.com/guilhermehn/expediente/blob/master/README.md')
  log('    for example config.')
  log('')
})

program.parse(process.argv)

// Set config load
configDir = program.config || defaultConfig

if (configFile = lib.loadConfig(configDir)) {
  Object
    .keys(defaults)
    .forEach(function (key) {
      config[key] = configFile.hasOwnProperty(key)
        ? configFile[key]
        : defaults[key]
    })
}
else {
  config = defaults
}

if (!program.args.length) {
  program.help()
}

config.start = program.args[0]

if (program.hours) {
  config.hours = program.hours
}

if (program.tolerance) {
  config.tolerance = program.tolerance
}

if (program.detailed) {
  config.detailed = program.detailed
  log = lib.logDetailed
}

log(expediente(config))
